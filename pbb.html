<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .link {
            fill: none;
            stroke: #999;
            stroke-opacity: 0.6;
        }
        .node img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }
        .node text {
            font-size: 12px;
            text-anchor: middle;
            fill: black;
        }
    </style>
</head>
<body>
    <svg width="800" height="600"></svg>
    <script>
        Promise.all([
            d3.csv("votes.csv"),
            d3.csv("duo_images.csv")
        ]).then(([votes, images]) => {
            let imageMap = {};
            images.forEach(d => { imageMap[d.DUO] = d.ImageURL; });

            let nodes = {};
            let links = votes.map(d => {
                nodes[d.DUO] = { name: d.DUO, img: imageMap[d.DUO] };
                nodes[d.GIVEN_BY] = { name: d.GIVEN_BY, img: imageMap[d.GIVEN_BY] };
                return { source: d.GIVEN_BY, target: d.DUO, value: +d.POINTS };
            });

            nodes = Object.values(nodes);

            let svg = d3.select("svg"),
                width = +svg.attr("width"),
                height = +svg.attr("height");

            let simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.name).strength(0.1))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2));

            let link = svg.selectAll(".link")
                .data(links)
                .enter().append("line")
                .attr("class", "link")
                .attr("stroke-width", d => d.value);

            let node = svg.selectAll(".node")
                .data(nodes)
                .enter().append("g")
                .attr("class", "node");

            node.append("image")
                .attr("xlink:href", d => d.img)
                .attr("x", -25)
                .attr("y", -25)
                .attr("width", 50)
                .attr("height", 50);

            node.append("text")
                .attr("dy", 35)
                .text(d => d.name);

            simulation.on("tick", () => {
                link.attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node.attr("transform", d => `translate(${d.x},${d.y})`);
            });
        });
    </script>
</body>
</html>
